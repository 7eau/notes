# 计算机网络

​	本笔记基于《计算机网络（第七版） 谢希仁编著》 2017年1月第7版。许多描述均来自书中原话，或本人简化；大部分图片、表格也是截取自该书。基于本人所面对的考试大纲，摘取部分知识点，仅作为个人学习、考试的笔记。

​	原书对于概念的描述其实是很清楚、易懂的，但是作为应试来说确实篇幅略长，但是有时间学习的话，很推荐阅读，会对于理解计算机网络由莫大帮助。

## 一、概述

### 1.1 考点大纲

- [ ] （1）计算机网络、互联网的发展与现状
- [ ] （2）网络体系结构层次化研究方法，协议结构、功能和原理
- [ ] （3）分组交换网
- [ ] （4）OSI/RM和TCP/IP体系结构

### 1.2 计算机网络、互联网的发展与现状

#### 1.2.1 什么是计算机网络？

通过有线、无线设备使得许多独立的主机能够实现资源共享、相互连通而形成的网状网络。

![image-20201215192614465](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215192614465.png)

#### 1.2.2 互联网的发展

第一阶段：由**单个网络**到**互联网**
第二阶段：**建成三级结构的互联网**（主干网、地区网、校园网）
第三阶段：形成了**多层次ISP（Internet Service Provider）的互联网**

![image-20201215193331472](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215193331472.png)

### 1.3 分组交换网

![image-20201215194245773](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215194245773.png)

### 1.4 计算机网络的类别

按作用范围：

WAN(Wide Area Network)：广域网
MAN(Metropolitan Area Network)：城域网
LAN(Local Area Network)：局域网
PAN(Personal Area Network)：个域网

按使用者：

（1）公用网
（2）专用网

### 1.5 基础概念

#### 时延

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215200158921.png" alt="image-20201215200158921" style="zoom:200%;" />

### 1.6.1 OSI/RM

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215200431269.png" alt="image-20201215200431269" style="zoom:200%;" />

#### 1.6.1 协议

定义的是两台主机间对等层次的规则。（主机A：网络层--->主机B：网络层）

组成：
	**语义**：发出何种控制信息、完成何种动作、作出何种反应
	**语法**：数据和控制信息的格式或结构
	**同步**：事件实现顺序的说明

#### 1.6.2 服务

定义的是同一主机中网络层次中上层对下层的规则。

**网络结构层次中下层开发接口，为上层提供服务（调用方法）**。上层不需要只知道下层的实现细节，根据接口就可以完成调用下层的功能。

#### 1.6.3 网络层次

##### 应用层

进程间的通信与交互。

协议

HTTP、SMTP（邮件协议）

数据单元

报文（message）

##### 传输层

两台主机之间的进程的通讯与交互。

协议

TCP：面向连接、可靠的数据传输。--报文段
UDP：无连接、不可靠的数据传输。--用户数据报

##### 网络层

分组交互网上不同主机间的通信与交互。

协议

IP

数据单元

分组（包）

##### 数据链路层

两个相邻节点之间的传输

数据单元

帧

##### 物理层

决定电压大小到1/0的转换、决定连接电缆的插头样式。

数据单元

比特（bit）

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215202723773.png" alt="image-20201215202723773" style="zoom:200%;" />

## 二、物理层和数据链路层

### 2.1 信道复用

#### 2.1.1  频分复用

所有用户在相同的时间占用不同的带宽资源。

#### 2.1.2 时分复用

所有用户在不同的时间占用相同的频带宽度。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215203719068.png" alt="image-20201215203719068" style="zoom:200%;" />

#### 2.1.3 统计时分复用

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215204331034.png" alt="image-20201215204331034" style="zoom:200%;" />

#### 2.1.4 波分复用

就是光的频分复用（光纤）

#### 2.1.5 码分复用

码分多址（CDMA）

一个bit划分成m个短的间隔

1：m bit码片序列（书写时写成+1）
0：m bit码片序列的反码（书写时将0写成-1）

例如：

> m bit码片序列为： 00011011（-1-1-1+1+1-1+1+1）
>
> 发送 1：00011011（-1-1-1+1+1-1+1+1）
> 发送 0：11100100（+1+1+1-1-1+1-1-1）

不同站的码片序列不仅不同，而且互相正交

![image-20201215210844192](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215210844192.png)

如S（-1-1-1+1+1-1+1+1）、T（-1-1+1-1+1+1+1-1）
	S*T = 0
	（带符号的一一对应相乘后相加，再除以m）

![image-20201215211915027](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215211915027.png)

​	S*S = 1

每一个站所发送的数据比特 = S * T
	结果为  1：发送1
	结果为 -1：发送-1
	结果为  0：未发送

### 2.2 宽带接入技术（有线）

#### 2.2.1 ADSL

![image-20201215214845881](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215214845881.png)

#### 2.2.2 光纤同轴混合网（HFC）

![image-20201215214858189](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215214858189.png)

#### 2.2.3 FTTX 技术

例如：FTTZ(光纤到小区)、FTTC（光纤到路边）、FTTH（光纤到家）……

### 2.3 局域网

#### 2.3.1 类别（网络拓扑）

星形、环形网、总线网（以以太网为主）

![image-20201216151451691](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201216151451691.png)

双绞线是局域网主流的传输媒（10Mbit/s~10Gbit/s）
当数据率很高时，就需要用到光纤了。

### 2.4 以太网

以太网是一种总线形局域网。局域网中的计算机被叫做“主机”、“站”……

以太网采用的是无连接的工作方式，本身是不可靠的交付。对于差错帧是否需要重传交由其高层决定（如，TCP协议决定何时以何种方式重传差错帧）。

同一时间总线上只能由一台主机在发送发送数据。如果发生冲突（发现由两台或两台以上主机同时在发送数据），则必须立刻停止所有主机发送，等待协调。

#### 2.4.1 CSMA/CD

以太网解决冲突的协调方式称为**CSMA/CD**：**载波监听多点接入/碰撞检测。**

以太网发送的是使用**曼彻斯特编码**的信号

![image-20201216154130619](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201216154130619.png)

CSMA/CD协议的要点

**多点接入**：说明这是总线型网络。

**载波监听**：实际就是检测信道，不管在发送前还是在发送中，每个站都必须不停地检测信道。

 - 发送前检测：为了获得发送权。
 - 发送中检测：为了及时发现碰撞（其他站也同时发送数据）

碰撞检测：就是“**边发送边检测信道**”。又称“冲突检测”

**为什么每次发送前都监听信道，还是会发送冲突呢？**

> 因为电磁波在总线总是以有限的速率在传播。可能同时出现两台或以上主机以为此时总线是空闲的情况。

根据以上所讨论的， 可以把CSMA/CD协议的要点归纳如下：
(1) **准备发送**：**适配器从网络层获得一个分组**， 加上以太网的首部和尾部，**组成以太网帧**， 放入适配器的缓存中。 但在**发送之前， 必须先检测信道**。

(2) **检测信道**：
	若检测到信道忙， 则应不停地检测， 一直等待信道转为空闲。 
	若检测到 信道空闲， 并在 **96比特时间内信道保持空闲（保证了帧间最小间隔）**， 就发送这个帧。

(3)在**发送过程中仍不停地检测信道**， 即网络适配器要边发送边监听。 这里只有两种可能性：
 - 发送成功：在争用期内一直未检测到碰撞。 这个帧肯定能够发送成功。 发送完毕后， 其他什么也不做。 然后回到
 - 发送失败：在争用期内检测到碰撞。 这时立即停止发送数据， 并按规定发送人为干 扰信号。 适配器接着就执行指数退避算法， 等待r倍512比特时间后， 返回到步骤(2)继续检测信道：但若重传达16次仍不能成功， 则停止重传而向上报错。

以太网每发送完一帧， 一定要把已发送的帧暂时保留一下。 如果在争用期内检测出发生了碰撞， 那么还要在推迟一段时间后再把这个暂时保留的帧重传一次。

#### 2.4.2 MAC

称硬件地址/物理地址或MAC地址。采用48（6字节）表示，是固化在（网络）适配器的ROM中的地址。

其中，前3个字节表示公司标识符；后三为由厂家自行指派。（EUI-48）

**另外，第一字节中的最低位为I/G位**（Individual/Group）。
	I/G位为 0：地址段表示单个地址。
	I/G位为 1：地址段表示组地址，用来**多播**

### 2.5 扩展的以太网

#### 2.5.1 交换设备

在数据链路层扩展设备。

最初是使用网桥。对收到的MAC帧的目的地址进行转发和过滤。

##### 交换机

后来使用的是交换式集线器（**以太网交换机**）：工作在数据链路层。

特点：

- 实质是一个多接口的网桥，通常由十几个或跟很多的接口。
- 每个接口都直接与一台主机或另一个以太网交换机相连。
- 采用全双工方式。
- 具有并行性，能够同时连通多对接口。
- 具有存储器，能在输出端口繁忙时把到来的帧进行缓存，用存储转发的方式进行转发。

##### 交换机的自学习功能

![image-20201216164200045](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201216164200045.png)

​		假定在图3-25 中的以太网交换机有4个接口， 各连接一台计算机， 其MAC地址分别是A, B, C和D。 在一开始， 以太网交换机里面的交换表是空的（图3-25(a)）。
​		A先向B发送一帧， 从接口1进入到交换机。 交换机收到帧后，先查找交换表， 没有查到应从哪个接口转发这个帧（在MAC地址这一列中， 找不 到目的地址为B的项目）。 接着， 交换机把这个帧的源地址A和接口1写入交换表中， 并向除接口1以外的所有接口广 播这个帧（这个帧就是从接口1进来的， 当然不应当把它再从接口1转发出去）。
​		C和D将丢弃这个帧，因为目的地址不对。只B才收下这个目的地址正确的帧。这也称为过滤。
从新写入交换表的项目(A,1)可以看出，以后不管从哪一个接口收到帧，只要其目的地址是A,就应当把收到的帧从接口1转发出去。这样做的依据是：既然A发出的帧是从接口1进入到交换机的，那么从交换机的接口1转发出的帧也应当可以到达A。

​		假定接下来B通过接口3向A发送一帧。交换机查找交换表，发现交换表中的MAC地址有A。 表明要发送给A的帧（即目的地址为A 的帧）应从接口1转发。 于是就把这个帧传送到接口1转发给A。 显然， 现在已经没有必要再广播收到的帧。 交换表这时新增加的 项目(B,3)， 表明今后如有 发送给B的帧， 就应当从接口3转发出去。

​		经过一段时间后，要转发给任何一台主机的帧，都能够很快地在交换表中找到相应的转发接口。

​		考虑到有时可能要在交换机的接口更换主机，或者主机要更换其网络适配器，这就需要更改交换表中的项目。为此，**在交换表中每个项目都设有一定的有效时间**。过期的项目就自动被删除。用这样的方法保证交换表中的数据都符合当前网络的实际状况。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201216172907069.png" alt="image-20201216172907069" style="zoom: 150%;" />

为了解决这种兜圈子问题，IEEE的802.1D标准制定了一个**生成树协议**STP (Spanning Tree Protocol)。其要点就是不改变网络的实际拓扑， 但在逻辑上则切断某些链路， 使得从一台主机到所有其他主机的路径是无环路的树状结构， 从而消除了兜圈子现象。

### 2.6 VLAN（虚拟局域网）

利用以太网的交换机实现的逻辑上的虚拟局域网，与物理位置无关。

![image-20201216173357208](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201216173357208.png)

![image-20201216232128563](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201216232128563.png)

### 2.7 高速以太网

**快速以太网**：100Mbit/s

**吉比特以太网**：
	允许在1Gbit/s下以全双工和半双工（CSMA/CD）两种方式工作。

10**吉比特以太网**：与以太网帧完全相同，用户仍可以以低速率方便的通信。
	只工作在全双工方式，不使用CSMA/CD协议。

**★现状及趋势**

现在以太网的工作范围已经从局域网扩大到城域网和广域网，从而实现了端到端的以太网传输。它有以下特点：①：以太网已经是一种成熟技术。②：以太网的互操作性也很好。③：价格便宜、适应性强。④：无需进行格式转换，简化了操作和管理。

## 三、网络层

TCP/IP层中常称作网际层（Internet Layer）~~=怎么英文是一样的呀=~~

### 3.1 考点大纲

（1）网络层和虚拟互连的基本概念
（2）IP地址、IPv4地址编址和IP协议
（3）划分子网和超网
（4）ICMP协议
（6）路由器和路由选择协议（RIP、OSPF、BGP）

**网络层向上只提供简单灵活的、无连接的、尽最大努利交付的数据报（分组）服务**

### 3.2 IP协议

与IP协议配套使用的还有三个协议：

- 地址解析协议ARP（Address Resolution Protocol）
- ★网际控制报文协议ICMP（Internet Control Message Protocol）
-  网际组管理协议IGMP（Internet Group Management Protocol）

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201218195927298.png" alt="image-20201218195927298"  />

#### 3.2.1 各层的中间设备

（1）物理层：转发器（repeater）。
（2）数据链路层：网桥或桥接器（bridge）——相当于把两个网络扩大成一个网络，从网络层的角度看，网桥连接后的网络就是一个网络。
（3）网络层：路由器（router）。有时也被叫做网关——一台专用计算机，用来在互联为中进行路由选择。
（4）在网络层以上：网关（gateway）。用网关连接两个不兼容的系统需要在高层进行协议的转换。

#### 3.2.2 虚拟互联网络

所谓虚拟互联网络，就是逻辑互联网络。利用IP协议将原本物理上是异构的网络，在网络层上，逻辑上是在同一个网络中，简称IP网。

![image-20201218201117373](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201218201117373.png)

如H~1~要把一个IP数据报发送到H~2~

![image-20201218201609353](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201218201609353.png)

#### 3.2.3 IP地址

IP地址就是每一台主机或路由器的一个32位（4字节）唯一标识符。

以下讨论分类的IP地址

`IP地址 ::= { <网络号>, <主机号>}`
	::= 表示定义为
	网络号：主机（或路由器）所连接到的网络。
	主机号：标志该主机（或路由器）。在主机所指明的网络范围内唯一

##### IP分类

![image-20201218212708676](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201218212708676.png)

##### IP分类取值

![image-20201218212617102](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201218212617102.png)

| **类别** | **网络号**                       | **特殊网络号**                                               | **主机号**                                               | **特殊主机号**                                               | **取值范围**                      |
| -------- | -------------------------------- | ------------------------------------------------------------ | -------------------------------------------------------- | ------------------------------------------------------------ | :-------------------------------- |
| A        | 1~126  （2^7^-2=126）            | 网络号为0保留：表示本网络；  网络号为127保留：作为本地软件回环测速（本主机的进程间通信使用） | **(\*.0.0.1)~(\*.255.255.254)**  (2^24^-2)               | 主机号全0保留：表示本主机  主机号全1保留：表示该网络所有主机（广播地址） | **(1.0.0.1)~(126.255.255.254)**   |
| B        | 128.1~191.255  （2^14^-1=16383） | 128.0.0.0不分配                                              | **（*****.\*.0.1)~(\*.\*.255.254)**  **(2^16^-2=65534)** | 主机号全0保留：表示本主机  主机号全1保留：表示该网络所有主机（广播地址） | **(128.1.0.1)~(191.255.255.254)** |
| C        | 192.0.1~223.255.255  (2^21^-1)   | 192.0.0.0不分配                                              | **（*****.\*.\*.1)~(\*.\*.\*.254)**  **(2^8^-2)**        | 主机号全0保留：表示本主机  主机号全1保留：表示该网络所有主机（广播地址） | **(192.0.1.1)~(223.255.255.254)** |
| D        | 多播地址，略                     |                                                              |                                                          |                                                              |                                   |

一般不使用的特殊IP地址

![image-20201218213520249](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201218213520249.png)

##### 重要特点

1. IP地址管理机构在分配IP地址时只分配网络号，主机号由得到该网络号的单位自行分配。
2. 路由器仅根据目的主机所连接的网络号来转发分组。这样减小了路由表所占存储空间以及查找路由表的时间。
3. 主机每连接一个网络就会获得一个对应的IP地址。
4. 同一局域网中的主机IP地址的网络号时一样的

### 3.3 ARP协议

通过**同一局域网**主机的IP地址找到其相应的物理地址。

ARP协议就是将IP地址与主机的物理地址一 一对应起来。它在高速缓存（APR cache）中存放一个**映射表**（路由表），并时常动态更新。

![image-20201220192128208](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220192128208.png)

Q1：**为什么需要ARP协议？或者说为什么需要找到主机的物理地址？**
	因为虽然IP地址已经可以在网络中定位到主机，但是由于在实际网络的链路上传送**数据帧**（对应于数据链路层）时还是必须使用该网络的硬件地址。

Q2：**既然传输时实际上是传送数据帧，即使用主机的硬件地址，那为什么还需要IP协议？**
	首先，MAC地址是以太网中使用的地址，而实际网络中不止以太网一种技术。如果仅仅有MAC地址，要使不同异构网络通信，则要有复杂的硬件地址转换。因此，使用网络层的IP地址来标识不同主机不仅不用转换，还可以很方便的区分两台主机。
	另外，可以简单的理解为MAC地址工作在第二层，是给机器看的；IP地址工作在第三层，是给人区分的。（当然实际上机器也用IP地址区分，只有查找到目标主机在同一局域网后才使用到MAC地址）



#### 路由表

构成：（目的网络地址， 下一跳地址）

![image-20201220201340358](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220201340358.png)

分类：以上图R2为例

| 目的主机所在的网络地址 | 下一跳地址         |
| ---------------------- | ------------------ |
| 和路由在同一网络       | 直接交付，接口`x`  |
| 和路由不在同一网络     | 给出下一跳路由地址 |
| （默认路由★）其他      | 给出下一跳路由地址 |

在得到下一跳IP地址后，会交由数据链路层处理。即将IP地址转换成MAC地址（使用ARP协议），然后根据硬件地址找到下一跳路由器。

### 3.4 划分子网

#### **3.4.1 从2级网络到3级网络**

2级IP地址设计的不合理导致一些问题（IP地址浪费、使用不够灵活、路由表变得太大）

因此，引入了子网号段，将2级网络变成了3级网络。

以上这种做法就叫做**划分子网（子网寻址或子网路由选择）**

#### 3.4.2 划分子网

从主机号中借用几位来表示子网号。对外表现为一个网络，对内表现为多个子网。

```
IP地址 ::= {<网络号>， <子网号>， <主机号>}
```

路由器在收到IP数据报后，在按目的网络号和子网号找到目的网络的子网，把IP数据报交付目的主机。

![image-20201220214433822](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220214433822.png)

##### 子网掩码

通过子网掩码可以分辨一个网络是否划分子网。

![image-20201220214619978](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220214619978.png)

三级网络下，通过将IP地址与网络掩码“**按位与**”即可得到该IP地址对对应的网络地址。

例：

IP地址：141.14.72.24，子网掩码：225.255.192.0，求其网络号

![image-20201221201134512](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201221201134512.png)

##### 使用子网时的分组转发

1. **从数据报中提取目的IP地址**
2. **先判断是否直接交付**。即求目的IP地址的网络号（用各网络的子网掩码），检测是否可以直接交付（看结果是否和相应网络地址匹配）。如果可以，则直接交付；否则，继续。
3. 若**路由表中已有该IP地址**，则按路由表中指明的下一跳转发；否则，继续。
4. **按行将每一行的子网掩码与目的IP地址“按位与”，得到对应的网络地址。**若和该行IP地址对应的网络地址匹配，则按其对应下一跳交付；否则，继续。
5. 若路由器有默认路由，则按其下一跳交付；否则，继续。
6. 报告转发分组出错。

例：

![image-20201221203608952](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201221203608952.png)

![image-20201221203653283](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201221203653283.png)

### 3.5 划分超网

#### 3.5.1 概念

又称无分类域间路由选择（CIDR）

- 消除了传统的A、B、C类地址以及划分子网的概念。
- 采用无分类的两级编址。

```
IP地址 ::= {<网络前缀>，<主机号>}
```

#### 3.5.2 CIDR记法

##### 斜线记法

书写时一般采用“斜线记法”，即`IP地址/<网络前缀位数>`

如`128.14.35.7/20`

![image-20201221205037865](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201221205037865.png)

##### 简记法

将**点分十进制**中低位连续0省略。

如`10.0.0.0/10`简写成`10/10`

##### *号法

在网络前缀后加一个`*`号

如`00001010 00*`：`*`号前表示网络前缀，`*`号表示主机号，可以为任意值。

#### 3.5.3 CIDR地址块

##### 概念

将网络前缀相同的连续IP地址组成一个CIDR地址块，我们就可以很容易的知道这个地址块中的最小地址和最大地址。

![image-20201221205207569](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201221205207569.png)

`128.14.32.0/20`则表示该地址块（使用该地址块的最小地址表示）

依旧沿用、保留了子网掩码。如`/20`地址块的子网掩码

```
11111111 11111111 11110000 00000000
```

虽然概念上超网并没有划分专门的子网号，但是依旧可以通过子网掩码来划分子网。如`\20`地址块要划分8个子网，则需要从主机号中借用3位，则其网络前缀就变成`/23`，其子网掩码

```
11111111 11111111 11111110 00000000
```

##### **求地址块的最小地址**：

​	若该IP地址的网络前缀位数为R，则保留IP地址（换成2进制）中前R位不变，后32-R位改为0即可。

##### **求地址块的最大地址**：

​	若该IP地址的网络前缀位数为R，则保留IP地址（换成2进制）中前R位不变，后32-R位改为1即可。

![image-20201221211713627](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201221211713627.png)

例，某ISP已拥有地址块`206.0.64.0/18`，二某大学现在需要800个IP地址，则可以给该大学分配一个地址块`206.0.68.0/22`

![image-20201221212025483](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201221212025483.png)

#### 3.5.4 最长前缀匹配

现在在路由表中每个项目由网络前缀和下一跳地址组成，但是问题来了，可能匹配结果会不止一个，这个时候就要采用最长前缀匹配算法。

例：

![image-20201221212649636](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201221212649636.png)

### 3.6 路由选择协议

#### 3.6.1 分类

1. 内部网关协议IGP（自洽系统内部使用的，又称域间路由选择）：RIP、OSPF；
2. 外部网关协议EGP（不同自治系统间使用的，又称域内路由选择）：GBP。

#### 3.6.2 RIP协议

“距离-目的网络”路由交换协议。
	距离：当前网络到目的网络的跳数（路由表中的距离均为最短距离）定义如下：
        ① 目的网络和当前网络在同一网络时，跳数的值为1。
        ② 不在一个网络时，`距离 = 经过路由器的数目 + 1`。

特点：

- 只和相邻路由交换信息。
- 交换的信息是路由表。
- 按固定间隔时间交换。

##### 距离向量算法

1. 对地址为X的相邻路由发来的RIP报文，先修改该报文中所有行的“下一跳地址”为X，对应的距离`+1`。

2. 逐行检查。

   - 若目的地址不存在，则按该RIP报文添加。

   - 若目的地址存在，则查看下一跳地址是否为X。是X，则替换新信息；不是X，则比较距离，使路由中留下距离最下的那一个信息。

3. 3分钟未收到相邻路由的更新路由表，则标记该路由不可达（把距离置为16=不可达）

4. 返回。

算法特点：**好消息传的快，坏消息传的慢。**

RIP的优点：实现简单，开销小。

RIP的缺点：限制了网络规模，能使用的最大距离是15；坏消息传的慢，更新过程的收敛时间过长。

#### 3.6.3 OSPF协议

叫做**开放最短路径优先OSPF**，使用的是**分布式的链路状态协议**。

特点：

- 发送方式：**采用“洪泛式”**：通过路由的所有输出端口相所有相邻路由发送信息，并依次重复。一段时间后，该**区域**所有路由均得到了这个信息。

- 发送的信息：与本路由相邻的所有路由的链路状态：本路由和哪些路由相邻以及该链路的“度量（可以是费用、距离、时间……比较灵活，由管理员决定，也叫做代价）”

- 何时发送：只有链路状态发生变化时才发送。



OSPF的优点：更新过程收敛的很快；每个路由都知道全区域的拓扑结构，可以利用最短路径路由算法构造自己的路由表。

##### 区域划分

OSPF将一个自治网络划分成若干更小的范围，叫做区域。每个区域都有一个32位的区域标识符。

![image-20201222210428205](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201222210428205.png)

使用层次结构的区域划分。
	上：主干区域，标识符为`0.0.0.0`，用来连通其他在下层的区域。其他区域的信息由**区域边界路由器**进行概括。在主干区域的路由器叫做**主干路由器**。

##### OSPF特点

- 不同类型的业务可以计算出不同的路由。
- 如果到一个网络有多条代价相同的链路，则可以将通信量分配给这几条链路，即负载均衡。
- OSPF支持子网划分和超网。

##### 分组类型

1. 问候分组：发现和维持临站的可达性。
2. 数据库描述分组。
3. 链路状态请求分组。
4. 链路状态更新分组。
5. 链路状态确认分组。

![image-20201223081921030](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223081921030.png)

#### 3.6.4 BGP协议

采用路径向量路由选择协议。

配置BGP时，至少选择一个路由器作为该自治区域（AS）的“**BGP发言人**”，不同AS间的发言人采用TCP连接（端口179），交换彼此的路由信息。

![image-20201223082603996](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223082603996.png)

BGP支持超网。

在RFC4271中规定了BGP-4的四种报文：
（1）OPEN（打开）报文，用来与相邻的另一个BGP发言人建立关系，**使通信初始化**。
（2）UPDATE（**更新**）报文，用来通告某一路由的信息，以及列出要撤销的多条路由。
（3）KEEPALIVE（保活）报文，**用来周期性地证实邻站的连通性。**
（4）NOTIFICATION（通知）报文，**用来发送检测到的差错。**

## 四、运输层

通信的真正断电并不是主机而是主机中的进程。运输层正是用来解决进程间的通讯。

### 4.1 分类

#### 4.1.1 TCP

面向连接的、可靠的**传输控制协议TCP**。不可避免的需要确认、流量控制、计时器以及连接管理等。

#### 4.1.2 UDP 

面向无连接的、不可靠的**用户数据报协议UDP**。

![image-20201223151109284](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223151109284.png)

常见的使用UPD或TCP协议的各种应用或应用层协议

![image-20201223151148104](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223151148104.png)

**记住TCP：SMTP 、Telnet、 HTTP、 FTP，其余基本就是UDP。**

### 4.2 端口

用来标记本计算机应用进程的标识符，叫做**端口**。端口号只具有本地意义。

在 TCP/IP的运输层，用16位（**最大值65535**）的端口号来标志一个端口。

#### 熟知端口号

（0~1023）

![image-20201223151842865](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223151842865.png)

#### 非熟知端口号

（1024~49151）

以上两种时服务端的端口号。

#### 客户端端口号

（49152~65535）

### 4.3 UDP

#### 特点

- 无连接、不可靠
- 尽最大努利交付
- 面向报文：对应用程序交下来的报文，在添加首部后就向下交付IP层。
- 无拥塞控制
- 支持一对一、一对多、多对一和多对多的交互通信。
- 首部开销小。

![image-20201223152528317](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223152528317.png)

#### 格式

UDP有两个字段：**数据字段**和**首部字段**

##### 首部字段

（1）源端口源端口号。在需要对方回信时选用。不需要时可用全0。
（2）目的端口目的端口号。这在终点交付报文时必须使用。
（3）长度UDP用户数据报的长度，其最小值是8（仅有首部）。
（4）检验和检测UDP用户数据报在传输中是否有错。有错就丢弃。

![image-20201223152823094](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223152823094.png)

伪首部：仅仅用来计算校验和，不向下、向上传送。

### 4.4 TCP

#### 4.4.1 特点

- 面向连接的、可靠的
- TCP连接只能是点对点的
- 全双工通信
- 面向字节流

![image-20201223153611088](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223153611088.png)

**TCP并不关心应用进程一次把多长的报文发送到TCP的缓存中**，而实根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应该包含多少个字节（UDP发送的报文长度是应用进程给出的）。**如果应用进程传送到TCP缓存的数据块太长，TCP就可以把它划分短一些再传送。**如果应用进程一次只发来一个字节，TCP也可以等待积累有足够多的字节后再构成报文段发送出去。

#### 4.4.2 TCP的连接

TCP的连接端口实际上叫做**套接字（socket）**

```
套接字 socket = (IP地址：端口号)
```

TCP连接：由协议软件所提供的一种抽象。

```
TCP连接 ::= {socket1, socket2} = {{IP1:port1}, {IP2:port2}}
```

#### 4.4.3 工作原理

##### 自动重传请求ARQ	

停止等待协议，常称**自动重传请求ARQ。**

即，发送分组-等待确认-超时重传。

![image-20201223161429058](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223161429058.png)

等待时间应该要比往返时间RTT更长一些。

确认丢失时：

![image-20201223161600359](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223161600359.png)

##### 信道利用率

![image-20201223161719074](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223161719074.png)

![image-20201223161729078](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223161729078.png)

T~D~：发送分组所需时间
RTT：传输往返时间
T~A~：B发送确认分组需要的时间

##### 连续ARQ协议

![image-20201223162109893](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223162109893.png)

**位于发送窗口内的5个分组都可连续发送出去，而不需要等待对方的确认**。**发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置。**图5-13（b）表示发送方收到了对第1个分组的确认，于是把发送窗口向前移动一个分组的位置。如果原来已经发送了前5个分组，那么现在就可以发送窗口内的第6个分组了。
接收方一般都是采用累积确认的方式。这就是说，接收方不必对收到的分组逐个发送确认，而是在收到几个分组后，对按序到达的最后一个分组发送确认，这就表示：到这个分组为止的所有分组都已正确收到了。

##### 格式

###### 首部格式

**TCP报文段首部的前20个字节是固定的（图5-14），后面有4n字节是根据需要而增加的选项（n是整数）。因此TCP首部的最小长度是20字节。**

![image-20201223162459021](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223162459021.png)

- 确认号：占4字节，**是期望收到对方下一个报文段的第一个数据字节的序号。**
- 数据偏移：占4位，**它指出TCP报文段的数据起始处距离TCP报文段的起始处有多远**。**“数据偏移”的单位是32位字（即以4字节长的字为计算单位）。**由于4位二进制数能够表示的最大十进制数字是15，因此数据偏移的最大值是60字节，**这也是TCP首部的最大长度（即选项长度不能超过40字节）。**
- 保留：占6位，保留为今后使用，但目前应置为0。
- 紧急URG：当URG=1时，表明紧急指针字段有效。**它告诉系统此报文段中有紧急数据，应尽快传送**（相当于高优先级的数据），而不要按原来的排队顺序来传送。
- 确认ACK：**仅当ACK=1时确认号字段才有效。**当ACK=0时，确认号无效。TCP规定，**在连接建立后所有传送的报文段都必须把ACK置1。**
- 推送PSH：当两个应用进程进行交互式的通信时，有时在一端的应用进程希望在键入一个命令后立即就能够收到对方的响应。在这种情况下，TCP就可以使用推送（push）操作。这时，发送方TCP把PSH置1，并立即创建一个报文段发送出去。**接收方TCP收到PSH=1的报文段，就尽快地（即“推送”向前）交付接收应用进程，而不再等到整个缓存都填满了后再向上交付。**
- 复位RST：**当RST=1时，表明TCP连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接。**RST置1还用来拒绝一个非法的报文段或拒绝打开一个连接。RST也可称为重建位或重置位。
- 同步SYN：**在连接建立时用来同步序号。**当SYN=1而ACK=0时，表明这是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中使SYN=1和ACK=1。**因此，SYN置为1就表示这是一个连接请求或连接接受报文。**
- 终止FIN：用来释放一个连接。当FIN=1时，表明此报文段的发送方的数据已发送完毕，并要求释放运输连接。
- 窗口：占2字节。窗口值是[0，216-1]之间的整数。**窗口指的是发送本报文段的一方的接收窗口**（而不是自己的发送窗口）。窗口值告诉对方：从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量（以字节为单位）。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。总之，窗口值**作为接收方让发送方设置其发送窗口的依据。**
- 检验和占2字节。**检验和字段检验的范围包括首部和数据这两部分**。和UDP用户数据报一样，在计算检验和时，要在TCP报文段的前面加上12字节的伪首部。伪首部的格式与图5-5中UDP用户数据报的伪首部一样。但应把伪首部第4个字段中的17改为6（TCP的协议号是6），把第5字段中的UDP长度改为TCP长度。接收方收到此报文段后，仍要加上这个伪首部来计算检验和。若使用IPv6，则相应的伪首部也要改变。
- 紧急指针：**占2字节。紧急指针仅在URG=1时才有意义，它指出本报文段中的紧急数据的字节数（紧急数据结束后就是普通数据）。**因此，紧急指针指出了紧急数据的末尾在报文段中的位置。当所有紧急数据都处理完时，TCP就告诉应用程序恢复到正常操作。值得注意的是，即使窗口为零时也可发送紧急数据。
- 选项长度可变，最长可达40字节。当没有使用“选项“时，TCP的首部长度是20字节。

#### 4.4.4 流量控制

![image-20201223172037649](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223172037649.png)

为了解决B发送0窗口值后，再一次的非零窗口请求丢失，而A持续等待非零窗口的情况，TCP为每一个连接设置了一个**持续计时器**。**只要TCP连接的一方收到对方的零窗口通知，就启动持续计时器。若持续计时器设置的时间到期，就发送一个零窗口探测报文段（仅携带1字节的数据），而对方就在确认这个探测报文段时给出了现在的窗口值。如果窗口仍然是零，那么收到这个报文段的一方就重新设置持续计时器。如果窗口不是零，那么死锁的僵局就可以打破了。**

#### 4.4.5 拥塞控制

就是指防止过多的数据注入到网络中，这样可以时网络中的路由器或链路不致过载。

![image-20201223173437535](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223173437535.png)

为了集中精力讨论拥塞控制，我们假定：
（1）数据是单方向传送的，对方只传送确认报文。
（2）接收方总是有足够大的缓存空间，因而发送窗口的大小由网络的拥塞程度来决定。

##### 基于窗口的拥塞控制

**发送方维持一个叫做拥塞窗口。拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化。发送方让自己的发送窗口等于拥塞窗口。**

发送方控制拥塞窗口的原则是：

	- 只要网络没有出现拥塞，拥塞窗口就可以再增大一些，以便把更多的分组发送出去。
	-  只要网络出现拥塞或有可能出现拥塞，就必须把拥塞窗口减小一些，以减少注入到网络中的分组数。

**判断网络拥塞的依据就是出现了超时。**

###### 慢开始

慢开始算法的思路是这样的：
	当主机开始发送数据时，由小到大逐渐增大发送窗口，即由小到大逐渐增大拥塞窗口数值。
	**每收到一个对新的报文段的确认后，可以把拥塞窗口增加最多一个SMSS（发送方的最大报文段）的数值。**（下面的例子只是简单说明，不合实际）
	

```
拥塞窗口cwnd每次的增加量=min（N，SMSS）
	- N是原先未被确认，但刚被确认的字节数。
```

​	在一开始发送方先设置cwnd=1，发送第一个报文段M1，接收方收到后确认M1。
​	发送方收到对M1的确认后，把cwnd从1增大到2，于是发送方接着发送M2和M3两个报文段。接收方收到后发回对M2和M3的确认。
​	发送方每收到一个对新报文段的确认（重传的不算在内）就使发送方的拥塞窗口加1。因此发送方在收到两个确认后，cwnd就从2增大到4，并可发送Ma~M共4个报文段（见图5-24）。
​	因此使用慢开始算法后，每经过一个传输轮次，拥塞窗口cwnd就加倍。

![image-20201223175128599](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223175128599.png)

**在TCP的实际运行中，发送方只要收到一个对新报文段的确认，其拥塞窗口cwnd就立即加1，并可以立即发送新的报文段，而不需要等这个轮次中所有的确认都收到后。**

###### 拥塞控制

为了防止拥塞窗口cwnd增长过大引起网络拥塞，还需要设置一个慢开始门限 ssthresh状态变量。慢开始门限ssthresh的用法如下：
	当cwnd<ssthresh时，使用上述的慢开始算法。
	当cwnd>ssthresh时，停止使用慢开始算法而改用拥塞避免算法。
	当cwnd=ssthresh时，既可使用慢开始算法，也可使用拥塞避免算法。

**拥塞避免算法的思路是让拥塞窗口cwnd缓慢地增大**（加法增大）

例子

![image-20201223183522042](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223183522042.png)

拥塞避免并不能够完全避免拥塞，仅仅是使网络不容易出现拥塞。

1. 当cwnd到达ssthresh初始值时，开始拥塞避免算法，cwnd开始线性增加。
2. 当网络出现拥塞时（发生超时），调整`ssthresh = cwnd / 2`，`cwnd`值置1，重新开始慢开始。

##### 快重传

发送方只要一连收到3个重复确认，就知道接收方未收到某报文，此时立即进行重传。

![image-20201223184228771](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223184228771.png)

##### 快恢复

发送方发现不是出现拥塞而只是丢失了个别报文的情况，于是不启动慢开始，而是执行恢复算法。
	调整门限值`ssthresh = cwnd / 2` ，同时设置`cwnd = ssthresh`，并开始执行拥塞避免算法。该过程叫做“乘法减小”。

![image-20201223184637608](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223184637608.png)

综合流量控制与拥塞控制，可以得知：

```
发送方窗口的上限值=Min[rwnd，cwnd]
	- rwnd 接收方窗口大小
	- cwnd 拥塞窗口大小
```

#### 4.4.6 TCP连接

##### 建立连接（三次握手）

![image-20201223185008996](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223185008996.png)

##### 释放连接（四次握手）

![image-20201223185312268](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223185312268.png)

**为什么A在TIME-WAIT状态必须等待2MSL的时间呢？这有两个理由。**

- 第一，**为了保证A发送的最后一个ACK报文段能够到达B。这个ACK报文段有可能丢失，因而使处在LAST-ACK状态的B收不到对已发送的FIN+ACK报文段的确认。B会超时重传这个FIN+ACK报文段，而A就能在2MSL时间内收到这个重传的FIN+ACK报文段。接着A重传一次确认，重新启动2MSL计时器。**最后，A和B都正常进入到CLOSED状态。如果A在TIME-WAIT状态不等待一段时间，而是在发送完ACK报文段后立即释放连接，那么就无法收到B重传的FIN+ACK报文段，因而也不会再发送一次确认报文段。这样，B就无法按照正常步骤进入CLOSED状态。
- 第二，**防止上一节提到的“已失效的连接请求报文段”出现在本连接中**。A在发送完最后一个ACK报文段后，再经过时间2MSL，就可以使本连接持续的时间内所产生的所有报文段都从网络中消失。这样就可以使下一个新的连接中不会出现这种旧的连接请求报文段。B只要收到了A发出的确认，就进入CLOSED状态。同样，B在撤销相应的传输控制块TCB后，就结束了这次的TCP连接。我们注意到，B结束TCP连接的时间要比A早一些。

## 五、应用层

### 5.1 DNS

用于将用户便于记忆的域名与IP地址的转换。

分类：

- 根域名服务器
- 顶级域名服务器
- 权限域名服务器
- 本地域名服务器

域名解析的过程

1. 向本地域名服务器**递归查询**（未查到则由本地域名服务器向其他域名服务器查询）
2. 本地域名服务器向根域名服务器的查询时**迭代查询**（即不代替本地域名服务器查询，而是告诉本地域名服务器接下来去哪里查询或者把IP地址直接告诉它。）

![image-20201223202720041](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223202720041.png)

### 5.2 FTP协议

文件传送协议，提供交互式的访问、使用TCP可靠的传输服务。

主进程的工作步骤如下：
（1）打开熟知端口（端口号为21），使客户进程能够连接上。
（2）等待客户进程发出连接请求。
（3）启动从属进程处理客户进程发来的请求。从属进程对客户进程的请求处理完毕后即终止，但从属进程在运行期间根据需要还可能创建其他一些子进程。
（4）回到等待状态，继续接受其他客户进程发来的请求。主进程与从属进程的处理是并发进行的。

![image-20201223204011037](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223204011037.png)

控制进程端口：21

数据传输进程端口：20

### 5.3 HTTP

超文本传输协议，不仅传送完成超文本跳转所需的信息，还可以从互联网上得到任何信息，如文本、超文本、声音、图像。

![image-20201223204423169](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223204423169.png)

## 六、计算机网络的发展趋势

### 6.1 P2P

P2P应用的范围很广，例如，文件分发、实时音频或视频会议、数据库系统、网络服务支持（如P2P打车软件、P2P理财等）

**P2P文件分发不需要使用集中式的媒体服务器，而所有的音频/视频文件都是在普通的互联网用户之间传输的。**这其实是相当于有很多（有时达到上百万个）分散在各地的媒体服务器（由普通用户的计算机充当这种媒体服务器）向其他用户提供所要下载的音频/视频文件。这种P2P文件分发方式解决了集中式媒体服务器可能出现的瓶颈问题。

**目前在互联网流量中，P2P工作方式下的文件分发已占据了最大的份额，比万维网应用所占的比例大得多。因此单纯从流量的角度看，P2P文件分发应当是互联网上最重要的应用。**现在P2P文件分发不仅传送音频文件MP3，而且还传送视频文件（10~1000MB，或更大）、各种软件和图像文件。

### 6.2 IPV6

与IPv4相比

- **更大的地址空间：128位**
- 扩展的地址层次结构
- **灵活的首部格式：定义了许多可选的首部格式**
- 改进的选项：**可以包含一些新的选项**，但IPV6的首部长度的固定的，选项放在有效载荷中
- 循序协议继续扩充
- 支持即插即用，无需DHCP
- 支持资源的预分配
- **首部改位8字节对齐（即必须时8字节的整数倍）**

![image-20201223210325164](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223210325164.png)

与IPv4相比，IPv6对首部中的某些字段进行了如下的更改：·取消了首部长度字段，因为它的首部长度是固定的（40字节）。

- **取消了服务类型字段**，因为优先级和流标号字段实现了服务类型字段的功能。
- **取消了总长度字段**，改用有效载荷长度字段。
- **取消了标识、标志和片偏移字段**，因为这些功能已包含在分片扩展首部中。
- **把TTL字段改称为跳数限制字段**，但作用是一样的（名称与作用更加一致）。
- **取消了协议字段**，改用下一个首部字段。
- **取消了检验和字段**，这样就加快了路由器处理数据报的速度。我们知道，在数据链路层对检测出有差错的帧就丢弃。在运输层，当使用UDP时，若检测出有差错的用户数据报就丢弃。当使用TCP时，对检测出有差错的报文段就重传，直到正确传送到目的进程为止。因此在网络层的差错检测可以精简掉。
- **取消了选项字段**，而用扩展首部来实现选项功能。



**IPV6使用冒号16进制记法**：

- 每16位的值改用十六进制表示，各值之间用冒号分隔。
- 允许把数字前的0省略
- 允许零压缩：一连串连续的零可以为一堆冒号所代替。但是只能使用一次零压缩

例1：

```
104.230.140.100.255.255.255.255.0.0.17.128.150.10.255.255
```

变为：

```
68E6:8C64:FFFF:FFFF:0:1180:960A:FFFF
```

例2：

```
FF05:0:0:0:0:0:0:B3
= FF05::B3
```

![image-20201223211601696](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223211601696.png)

![image-20201223211727349](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223211727349.png)

### 6.3 无线局域网WLAN

使用802.11系列协议的局域网又叫做Wi-Fi

分类：

- 有固定基础设置的：如移动电话网络等
- 无固定基础设置的：自组网络。如无线传感网络（由大连传感器节点通过无线通信技术构成的自组网络，用以数据的采集、处理和传输）

## 七、网络安全基础

### 7.1 密码体制

#### 对称密钥密码体制

加密密钥与解密密钥使用相同的密码体制。

![image-20201223213118942](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223213118942.png)

三重DES

把一个64位明文由一个密钥加密，用另一个密钥解密，再用第一个密钥加密。

#### 公钥密码体制

使用不同的加密密钥PK（public key ，即公钥）和解密密钥（secret key 即私钥）。其加密算法E和解密算法D也是公开的。

1. 密钥对产生器产生出接收者B的一对密钥：加密密钥PK~B~和解密密钥SK~B~。
2. 发送者A使用PK~B~通过E运算对明文X进行加密得到密文Y，发送给B。
3. B用自己的私钥SK~B~通过D运算解密，恢复出明文。

具有以下特点：

- 不可能从PK~B~推导SK~B~。
- 公钥可以用来加密，却不能用来解密。
- 先后对X进行D运算和E运算或进行E运算和D运算，结果都是一样的。

![image-20201224000535951](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224000535951.png)

### 7.2 数字签名

特点

- 能够报文鉴定（确认该报文的确是发送者发送的）
- 能够确保报文的完整性
- 不可否认（发送者事后不能抵赖对报文的签名）

![image-20201224000913034](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224000913034.png)

同时进行加密和数字签名

![image-20201224001428581](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224001428581.png)

### 7.3 鉴别

验证通讯的对方的确是自己所要通讯的对象。

#### 密码散列函数

![image-20201224001750304](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224001750304.png)

特点

- 输入可以很长，但是输出是固定长度的。
- 不同的输入可能得到相同的输出，但是却无法根据相同的输出逆向得到不同的输入，也就无法逆向得到原始输入。

应用：MD5和SHA-1

#### 报文鉴定码

![image-20201224002655468](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224002655468.png)

其中加密散列结果还可以采用类数字签名的公钥密码体制方式：

1. A用A的私钥对X的散列结果进行E运算得到报文鉴定码
2. B收到拆分出鉴定码后使用A的公钥进行D运算解密得到散列结果`H’`若`H(X) = H'`则可认为报文未经篡改，且不可否认。

### 7.4 实体鉴别

#### 概念

在系统接入的全部持续时间内对和自己通信的对方实体只需验证一次。

![image-20201224003604013](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224003604013.png)

在图7-9中，A首先用明文发送其身份A和一个不重数R~A~给B。接着，B响应A的查问，用共享的密钥K~AB~对R~A~加密后发回给A，同时也给出了自己的不重数R~B~。最后，A再响应B的查问，用共享的密钥Ks对Ra加密后发回给B。这里很重要的一点是A和B对不同的会话必须使用不同的不重数集。由于不重数不能重复使用，所以C在进行重放攻击时无法重复使用所截获的不重数。

在使用公钥密码体制时，可以对不重数进行签名鉴别。例如在图7-9中，B用其私钥对不重数RA进行签名后发回给A。A用B的公钥核实签名，如能得出自己原来发送的不重数RA，就核实了和自己通信的对方的确是B。同样，A也用自己的私钥对不重数RB进行签名后发送给B。B用A的公钥核实签名，鉴别了A的身份。

#### 重放攻击

C把A加密的报文发送给B，是B误以为C是A，然后B就向C发送了许多应该给A的报文。对付重放攻击就是用到了一个**不重复的大随机数。**

#### 中间人攻击

![image-20201224004341646](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224004341646.png)

中间人C截获A、B的报文，加密不重数时均使用自己的私钥，然后交出自己的公钥，使得A、B被欺骗。

### 7.5 密钥的分配

#### 对称密钥的分配

设立密钥分配中心KDC，需要时临时给用户分配一个会话密钥。

![image-20201224005844170](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224005844170.png)

1. 用户A向密钥分配中心KDC发送时用明文，说明想和用户B通信。在明文中给出A和B在KDC登记的身份。
2. KDC用随机数产生“一次一密”的会话密钥K~AB~供A和B的这次会话使用，然后向A发送回答报文。这个回答报文用A的密钥KA加密。这个报文中包含这次会话使用的密钥K~AB~和请A转给B的一个票据（ticket），该票据包括A和B在KDC登记的身份，以及这次会话将要使用的密钥K~AB~。票据用B的密钥KB加密，A无法知道此票据的内容，因为A没有B的密钥KB，当然A也不需要知道此票据的内容。
3. 当B收到A转来的票据并使用自己的密钥Ka解密后，就知道A要和他通信，也知道KDC为这次和A通信所分配的会话密钥K~AB~。

#### 公钥的分配

通过认证中心CA来将公钥和其对应的实体进行绑定。每个实体都有CA发来的证书，里面由公钥和拥有者的信息，并且该证书被CA进行了数字签名。

### 7.6 安全协议

#### 运输层安全协议

- 安全套接字层SSL：应用于HTTP（https:443端口）、IMAP

  ![image-20201224011410902](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224011410902.png)

  ![image-20201224011515292](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224011515292.png)

- 运输层安全TLS（基于SSL改进）

### 7.7 防火墙

一种访问控制技术，通过严格控制进出网络边界的分组，禁止不必要的通信，从而减少潜在的入侵发生。

![image-20201224011810165](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224011810165.png)

分类

- 分组过滤路由器

  基于分组的网络层或运输层的首部信息（如源/目的IP地址、端口等），对进出内部网络的分组执行转发或者丢弃。

- 应用网关（代理服务器）

  在应用层通信中扮演报文中继的角色，所有进出网络的应用程序报文都必须通过应用网关。

#### 入侵检测系统（IDS）

IDS对进入网络的分组进行深度分组检测，发现可疑分组时，发出警告或执行阻断。

分为

- 基于特征的入侵检测

  维护一个已知攻击标志性特征的数据库。

- 基于异常的入侵检测

  观察正常运行的网络流量，学习正常流量规律和统计特性。当检测到异常统计规律时，则认为可能发生了入侵行为。

### 7.8 应用

- 椭圆曲线密码（ECC）与AES：已广泛用于电子护照中，也是下一代金融系统使用的加密系统
- 移动安全：如移动支付
- 量子密码：量子密码学尚未得到发展。